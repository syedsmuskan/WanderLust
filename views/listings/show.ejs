<% layout("/layouts/boilerplate") %>

<div class="container mt-3">
  <div class="row">

    <!-- IMAGE COLUMN -->
    <div class="col-md-6">
      <div class="card mb-3">
        <img 
          src="<%= listing.image && listing.image.url ? listing.image.url : 'https://via.placeholder.com/600x400' %>" 
          class="card-img-top show-image" 
          alt="listing image"
          style="height: 22rem; object-fit: cover;">
      </div>
    </div>

    <!-- DETAILS COLUMN -->
    <div class="col-md-6">
      <div class="card p-3">

        <h4 class="mb-1"><%= listing.title %></h4>
        <p class="text-muted mb-3">
          Hosted by
          <strong>
            <%= listing.owner && listing.owner.username ? listing.owner.username : "Unknown" %>
          </strong>
        </p>

        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Description:</strong> <%= listing.description %></li>
          <li class="list-group-item"><strong>Price:</strong> ₹ <%= listing.price %></li>
          <li class="list-group-item"><strong>Location:</strong> <%= listing.location %></li>
          <li class="list-group-item"><strong>Country:</strong> <%= listing.country %></li>
        </ul>

        <!-- ✅ AUTHORIZATION: ONLY OWNER CAN SEE -->
        <% if (currUser && listing.owner && currUser._id.equals(listing.owner._id)) { %>
          <div class="mt-3 d-flex gap-2">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary">
              Edit Listing
            </a>

            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
              <button class="btn btn-danger">Delete Listing</button>
            </form>
          </div>
        <% } %>

        <div class="mt-3">
          <a href="/listings">⬅ Back to all listings</a>
        </div>

      </div>
    </div>
  </div>

  <!-- REVIEW SECTION -->
  <div class="row mt-4">
    <div class="col-md-6">
      <h4>Leave a Review</h4>

      <% if (currUser) { %>
        <form 
          action="/listings/<%= listing._id %>/reviews" 
          method="POST" 
          class="needs-validation"
          novalidate>

          <div class="mb-3">
            <label for="rating" class="form-label">
              Rating: <span id="ratingValue" class="fw-bold">3</span>/5
            </label>

            <input 
              type="range"
              min="1"
              max="5"
              step="1"
              value="3"
              id="rating"
              name="review[rating]"
              class="form-range"
              required
              oninput="ratingValue.innerText = this.value">
          </div>

          <div class="mb-3">
            <label for="comment" class="form-label">Comment</label>
            <textarea 
              name="review[comment]" 
              id="comment" 
              class="form-control"
              rows="4"
              required></textarea>
          </div>

          <button class="btn btn-success">Submit</button>
        </form>
      <% } else { %>
        <p class="text-muted">Please <a href="/login">login</a> to leave a review.</p>
      <% } %>

      <hr />

      <h4 class="mb-3">All Reviews</h4>

      <% if (listing.reviews.length === 0) { %>
        <p class="text-muted">No reviews yet. Be the first one!</p>
      <% } else { %>
        <% for (let review of listing.reviews) { %>
          <div class="card mb-3 shadow-sm">
            <div class="card-body">

              <div class="mb-2">
                <% for (let i = 0; i < review.rating; i++) { %>
                  <span class="text-warning fs-5">&#9733;</span>
                <% } %>
                <% for (let i = review.rating; i < 5; i++) { %>
                  <span class="text-muted fs-5">&#9733;</span>
                <% } %>
              </div>

              <p class="card-text mb-2"><%= review.comment %></p>

              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  Reviewed on <%= review.createdAt.toDateString() %>
                </small>

                <!-- ✅ REVIEW AUTHORIZATION -->
                <% if (currUser && review.author && currUser._id.equals(review.author._id)) { %>
                  <form 
                    method="POST"
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button class="btn btn-sm btn-outline-danger">
                      Delete
                    </button>
                  </form>
                <% } %>
              </div>

            </div>
          </div>
        <% } %>
      <% } %>

    </div>
  </div>
</div>

